# Nature Nani - Database & Agent Setup

## ðŸš€ 1. The Bulletproof Database Sync (Run First)
Run this in your [Supabase SQL Editor](https://supabase.com/dashboard/project/_/sql). 
This script ensures the `public.app_users` table is perfectly synced with Supabase Auth.

```sql
-- 1. Ensure the public table exists with all required columns
CREATE TABLE IF NOT EXISTS public.app_users (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT UNIQUE NOT NULL,
  name TEXT,
  login_method TEXT DEFAULT 'password',
  subscription_status TEXT DEFAULT 'free',
  trial_end TIMESTAMPTZ DEFAULT (now() + interval '7 days'),
  is_service_user BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- 2. Create the robust sync function
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER SET search_path = public
AS $$
BEGIN
  INSERT INTO public.app_users (id, email, name, login_method, subscription_status)
  VALUES (
    new.id,
    new.email,
    COALESCE(new.raw_user_meta_data->>'full_name', 'Nature User'),
    COALESCE(new.raw_app_metadata->>'provider', 'password'),
    'free'
  )
  ON CONFLICT (id) DO UPDATE SET
    email = EXCLUDED.email,
    name = COALESCE(EXCLUDED.name, public.app_users.name);
  RETURN new;
EXCEPTION WHEN OTHERS THEN
  RETURN new;
END;
$$;

-- 3. Re-attach the trigger
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- 4. Create the Library Table (REQUIRED for Save to Library Feature)
CREATE TABLE IF NOT EXISTS public.nani_saved_plans (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  type TEXT NOT NULL, -- 'YOGA', 'DIET', 'REMEDY'
  plan_data JSONB NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now()
);

-- Enable RLS for nani_saved_plans
ALTER TABLE public.nani_saved_plans ENABLE ROW LEVEL SECURITY;

-- Allow users to view/edit ONLY their own saved plans
CREATE POLICY "Users can manage their own plans" ON public.nani_saved_plans
  FOR ALL USING (auth.uid() = user_id);

-- 5. Create Analytics Table (Optional but recommended)
CREATE TABLE IF NOT EXISTS public.nani_analytics (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  query TEXT,
  source TEXT,
  details TEXT,
  book_sources TEXT[],
  created_at TIMESTAMPTZ DEFAULT now()
);

-- Enable RLS for nani_analytics
ALTER TABLE public.nani_analytics ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can insert their own analytics" ON public.nani_analytics
  FOR INSERT WITH CHECK (auth.uid() = user_id);
```

## ðŸ¤– 2. Create the "Agent" User (Manual Method)

If you see "Trigger Configuration Error" in the app, follow these steps to create your Agent user manually:

1.  **Create Auth Account**:
    - Go to **Authentication > Users** in your Supabase Dashboard.
    - Click **"Add User"** -> **"Create new user"**.
    - **Email**: `agent@naturenani.com`
    - **Password**: `abcxyz909090` (Must match your `AGENT_PASSWORD` env variable).
2.  **Elevate to Service User**:
    - Copy the **User ID (UUID)** for this new user.
    - Go to the **SQL Editor** and run:

```sql
UPDATE public.app_users 
SET is_service_user = true, 
    subscription_status = 'active',
    name = 'Agent X'
WHERE id = 'YOUR_USER_ID_HERE';
```

## ðŸ”’ Security Policy
- Passwords **must** be at least 12 characters.
- Ensure your `nani_saved_plans` table has the RLS policy defined above, otherwise Saves will fail with a 403 or 500 error.
